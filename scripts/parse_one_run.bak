#!/usr/bin/perl 
use strict;
use warnings;

my $fn = $ARGV[0];
my $proto = defined $ARGV[1]?$ARGV[1]:'proto';

my %results= ();

sub process {
	my ($fn, $nc, $reqs, $reps) = @_;
        print "0>>>>>>>>>>>>>>>>> opening file fn $fn\n";
	open FIN, '<', $fn or die "Can't open $fn: $!";
        print "0b>>>>>>>>>>>>>>>>>>>>>file opened\n";
	while (<FIN>) {
                print "0c>>>>>>>>>>>>>>>>>>>>>>>inside while loop\n";
		next unless /(?:throughput)|(?:response time)/;
		if (/throughput :.*avg =\s+([\d.]+)\s+std dev =\s*((?:[\d.]+)|(?:inf))\s/) {
                        print "0e>>>>>>>>>>>>>>>>>>>>>>>1:  $1>>>>>>2:   $2>>>>>>\n";
			$results{TH} = [$1, $2 eq 'inf'?0:$2];
		} elsif (/response time: avg =\s+([\d.e\-\+]+)\s+std dev =\s*((?:[\d.e\-\+]+)|(?:inf))\s/) {
			$results{RT} = [$1, $2];
		}
                print "1>>>>>>>>>>>>>>>>>>$1\n";
                print "2>>>>>>>>>>>>>>>>>>$2\n";
	}
        print "3>>>>>>>>>>>>>>out of while loop\n";
	close FIN;
}

die "Can't parse filename\n" unless ($fn=~m/manager.out-(\d+)-(.+)-(\d+)/);
my($nc,$reqs,$reps) = ($1,$2,$3);

print STDERR "Processing: $fn\n";
process($fn, $1, $2, $3);

print STDERR "OUTPUT:\n";
#print STDOUT join "\t", ($proto, $reqs, $reps, $nc, 'c', @{$results{TH}}, @{$results{RT}});
print STDOUT "\n";
